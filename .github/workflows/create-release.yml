name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release from Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for tag message

      - name: Verify tag is on main branch
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          # Fetch main branch to check if tag is on it
          git fetch origin main:main 2>/dev/null || git fetch origin main

          # Check if the tag's commit is on main branch
          if ! git branch -r --contains "$TAG_NAME" | grep -q "origin/main"; then
            echo "Error: Tag $TAG_NAME is not on the main branch"
            echo "Releases can only be created for tags pushed to main"
            exit 1
          fi
          echo "âœ“ Tag $TAG_NAME is on main branch"

      - name: Extract version from tag
        id: tag_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}  # Remove 'v' prefix
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG_NAME"

      - name: Validate version format
        run: |
          VERSION="${{ steps.tag_version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9-]+)?(\+[a-zA-Z0-9-]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH[-prerelease][+build]"
            exit 1
          fi
          echo "Version format is valid: $VERSION"

      - name: Verify tag matches pyproject.toml version
        run: |
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          # Extract version from pyproject.toml using grep and sed
          # Handles both quoted and unquoted version strings
          PYPROJECT_VERSION=$(grep -E '^\s*version\s*=' pyproject.toml | sed -E 's/.*version\s*=\s*["'\'']?([^"'\''\s]+)["'\'']?.*/\1/')

          # Normalize versions for comparison (remove build metadata if present)
          TAG_NORMALIZED=$(echo "$TAG_VERSION" | cut -d'+' -f1)
          PYPROJECT_NORMALIZED=$(echo "$PYPROJECT_VERSION" | cut -d'+' -f1)

          if [ "$TAG_NORMALIZED" != "$PYPROJECT_NORMALIZED" ]; then
            echo "Error: Tag version ($TAG_VERSION) does not match pyproject.toml version ($PYPROJECT_VERSION)"
            exit 1
          fi
          echo "Version verification passed: $TAG_VERSION matches pyproject.toml"

      - name: Get tag message
        id: tag_message
        run: |
          TAG_NAME="${{ steps.tag_version.outputs.tag }}"
          # Get annotated tag message, or use default if tag message is empty
          TAG_MESSAGE=$(git tag -l --format='%(contents)' "$TAG_NAME" 2>/dev/null || echo "")
          if [ -z "$TAG_MESSAGE" ]; then
            TAG_MESSAGE="Release $TAG_NAME"
          fi
          # Escape for GitHub output (multiline)
          {
            echo 'message<<EOF'
            echo "$TAG_MESSAGE"
            echo EOF
          } >> $GITHUB_OUTPUT
          echo "Tag message length: ${#TAG_MESSAGE} characters"

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.tag_version.outputs.version }}';
            const tagName = '${{ steps.tag_version.outputs.tag }}';
            const releaseName = `v${version}`;
            const releaseBody = `${{ steps.tag_message.outputs.message }}`;

            try {
              const response = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: releaseName,
                body: releaseBody,
                draft: false,
                prerelease: version.includes('-') || version.includes('rc') || version.includes('alpha') || version.includes('beta')
              });

              console.log(`Release created successfully: ${response.data.html_url}`);
            } catch (error) {
              if (error.status === 422 && error.message.includes('already exists')) {
                console.log(`Release for tag ${tagName} already exists, skipping creation.`);
              } else {
                throw error;
              }
            }
